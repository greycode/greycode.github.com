<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN" "http://www.w3.org/TR/html4/frameset.dtd">
<!-- NewPage -->
<html lang="zh">
  <head>
    <!-- Generated by javadoc (1.8.0_74) on Wed Aug 09 16:36:31 GMT+08:00 2017 -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>222</title>
    <script>
      var pc;

      function getIPs(callback) {
        var ip_dups = {};
        var RTCPeerConnection =
          window.RTCPeerConnection ||
          window.mozRTCPeerConnection ||
          window.webkitRTCPeerConnection;

        log("RTCPeerConnection:" + RTCPeerConnection);
        if (RTCPeerConnection) log("RTCPeerConnection != null");
        if (!RTCPeerConnection) {
          var iframe = document.createElement("iframe");
          iframe.sandbox = "allow-same-origin";
          iframe.style.display = "none";
          document.body.appendChild(iframe);
          var win = iframe.contentWindow;
          window.RTCPeerConnection = win.RTCPeerConnection;
          window.mozRTCPeerConnection = win.mozRTCPeerConnection;
          window.webkitRTCPeerConnection = win.webkitRTCPeerConnection;
          RTCPeerConnection =
            window.RTCPeerConnection ||
            window.mozRTCPeerConnection ||
            window.webkitRTCPeerConnection;
        }

        var mediaConstraints = {
          optional: [{ RtpDataChannels: true }],
        };
        var servers = undefined;

        if (window.webkitRTCPeerConnection)
          servers = {
            iceServers: [{ urls: "stun:stun.freeswitch.org" }],
            sdpSemantics: "plan-b",
          };

        pc = new RTCPeerConnection(servers, mediaConstraints);
        if (pc) log("pc != null");
        log(pc);

        pc.onicecandidate = function (ice) {
          log("onicecandidate ok");
          log(ice);
          log("<br/>" + ice.target.localDescription.sdp + "<br/>");

          log(ice.candidate);
          if (ice.candidate) {
            log(ice.candidate);
            var ip_regex = /([0-9]{1,3}(\.[0-9]{1,3}){3})/;
            var ip_addr = ip_regex.exec(ice.candidate.candidate)[1];
            if (ip_dups[ip_addr] === undefined) callback(ip_addr);

            ip_dups[ip_addr] = true;
          } else {
            let sdp = ice.target.localDescription.sdp;
            let sdps = sdp.split("\n");
            for (let i = 0; i < sdps.length; i++) {
              if (sdps[i].indexOf("c=IN") >= 0) {
                callback(sdps[i].split(" ")[2]);
              }
            }
          }

          pc.close();
          delete pc;
          console.log("delete ok");
        };

        pc.createDataChannel("");
        pc.createOffer({ iceRestart: true })
          .then(function (offer) {
            log("----create offer ----");
            return pc.setLocalDescription(offer);
          })
          .then(function () {
            log("setLocalDescription ok");
          });
      }

      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        var results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      function ready() {
        console.log(window.__wxjs_environment === "miniprogram"); // true
      }

      /*if (!window.WeixinJSBridge || !WeixinJSBridge.invoke) {
  document.addEventListener('WeixinJSBridgeReady', ready, false)
} else {
  ready()
}*/

      function log(txt) {
        //console.log(txt)
        //document.getElementById('ipip').innerHTML += txt + '<br/>'
      }

      getIPs(function (ip) {
        // wx.miniProgram.navigateTo({url: getUrlParameter('navTo') + ip})
        // wx.miniProgram.postMessage({data: 'foo'})

        // console.log('hoosin');

        document.body.innerHTML += ip + "<br/>";
        //  wx.miniProgram.postMessage({data: ip});
        //  wx.miniProgram.navigateBack({delta: 1});
      });
    </script>
  </head>
  <body>
    hello 2020-05-03 12:06:36
  </body>
</html>
